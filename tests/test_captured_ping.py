import unittest
from aiovban.packet import VBANPacket
from aiovban.packet.headers.service import VBANServiceHeader, PingFunctions
from aiovban.packet.body.service import Ping
from aiovban.enums import DeviceType, Features, VBANSampleRate

class TestCapturedPing(unittest.TestCase):
    def test_validate_captured_ping(self):
        # Freshly captured packet from 192.168.10.114
        captured_hex = (
            "5642414e608000005642414e20536572766963650000000000000000200000000103010000000000000000007017000040c40a007896aa000300020800000000000000000000000000000000656e2d757300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000057696e646f777320504300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000056422d417564696f20536f6674776172650000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000566f6963656d656574657220506f7461746f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000062696c6c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
        )
        data = bytes.fromhex(captured_hex)
        packet = VBANPacket.unpack(data)
        ping_body = packet.body

        # Validate Header
        self.assertIsInstance(packet.header, VBANServiceHeader)
        self.assertEqual(packet.header.streamname, "VBAN Service")
        self.assertEqual(packet.header.function, PingFunctions.Response)

        # Validate Body (at least these should match)
        self.assertIsInstance(ping_body, Ping)
        self.assertEqual(ping_body.device_type, DeviceType.VirtualMixer)
        # self.assertEqual(ping_body.features, Features.Audio)
        self.assertEqual(ping_body.version, "8.2.0.3")
        
        # Round-trip validation
        repacked_data = packet.pack()
        # Verify the entire body matches the original bytes (up to length provided)
        # Note: We use repack to ensure consistency.
        self.assertEqual(repacked_data[:len(data)], data)

if __name__ == "__main__":
    unittest.main()
